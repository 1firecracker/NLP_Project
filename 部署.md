# AWS EC2 éƒ¨ç½²æŒ‡å—

å®Œæ•´çš„ LightRAG Web åº”ç”¨éƒ¨ç½²åˆ° AWS EC2 çš„æ­¥éª¤æŒ‡å—ã€‚

## ğŸ“‹ éƒ¨ç½²æµç¨‹æ¦‚è§ˆ

```
1. åˆ›å»º EC2 å®ä¾‹
   â†“
2. é…ç½® EC2 å®ä¾‹ï¼ˆå®‰è£…è½¯ä»¶ï¼‰
   â†“
3. é…ç½® GitHub Secretsï¼ˆLLM API Keyï¼‰
   â†“
4. è§¦å‘éƒ¨ç½²ï¼ˆGit Pushï¼‰
   â†“
5. é…ç½®æœåŠ¡å’Œ Nginx
   â†“
6. éªŒè¯éƒ¨ç½²
```

## æ­¥éª¤ 1: åˆ›å»º EC2 å®ä¾‹

1. **ç™»å½• AWS Console**
   - è®¿é—® https://console.aws.amazon.com/
   - è¿›å…¥ EC2 â†’ Launch Instance

2. **é…ç½®å®ä¾‹**ï¼š

**åŸºæœ¬ä¿¡æ¯ï¼š**
- **åç§°**: `lightrag-web-server`
- **AMI**: Amazon Linux 2023 æˆ– Ubuntu 22.04 LTS
- **å®ä¾‹ç±»å‹**: 
  - âœ… **æ¨è**: `t3.small` (2 vCPU, 2 GiB RAM, ~$0.0272/å°æ—¶)
  - ğŸš€ **ç”Ÿäº§**: `t3.medium` (4 GiB RAM, ~$0.0416/å°æ—¶)
  - âŒ **ä¸æ¨è**: `t3.micro` (1 GiB RAMï¼Œå†…å­˜ä¸è¶³)
- **å¯†é’¥å¯¹**: åˆ›å»ºæ–°å¯†é’¥å¯¹ï¼ˆå¦‚ `nlp-server1`ï¼Œé€‰æ‹© `.pem` æ ¼å¼ï¼‰

**ç½‘ç»œè®¾ç½®ï¼š**
- **å®‰å…¨ç»„**: åˆ›å»ºæ–°å®‰å…¨ç»„ï¼Œè§„åˆ™ï¼š
  ```
  SSH (22)     - æ¥æº: 0.0.0.0/0ï¼ˆâš ï¸ å¿…é¡»å…è®¸æ‰€æœ‰ IPï¼Œä»¥æ”¯æŒ GitHub Actions éƒ¨ç½²ï¼‰
  HTTP (80)    - æ¥æº: 0.0.0.0/0
  HTTPS (443)  - æ¥æº: 0.0.0.0/0
  ```
  
  **âš ï¸ é‡è¦è¯´æ˜**ï¼š
  - SSH (22) ç«¯å£å¿…é¡»å…è®¸æ¥è‡ª `0.0.0.0/0` çš„è¿æ¥ï¼Œå› ä¸º GitHub Actions è¿è¡Œåœ¨ GitHub çš„æœåŠ¡å™¨ä¸Šï¼ŒIP åœ°å€æ˜¯åŠ¨æ€çš„
  - è™½ç„¶è¿™æ ·å…è®¸æ‰€æœ‰ IP è®¿é—® SSHï¼Œä½†å®‰å…¨æ€§ç”± SSH å¯†é’¥å¯¹ä¿æŠ¤ï¼ˆåªæœ‰æ‹¥æœ‰ `.pem` æ–‡ä»¶çš„äººæ‰èƒ½è¿æ¥ï¼‰
  - å¦‚æœåªæƒ³å…è®¸æ‚¨è‡ªå·±çš„ IPï¼Œå¯ä»¥æ·»åŠ ä¸¤æ¡è§„åˆ™ï¼š
    - è§„åˆ™ 1: SSH (22) - æ¥æº: æ‚¨çš„ IP åœ°å€ï¼ˆç”¨äºæ‰‹åŠ¨è¿æ¥ï¼‰
    - è§„åˆ™ 2: SSH (22) - æ¥æº: 0.0.0.0/0ï¼ˆç”¨äº GitHub Actionsï¼Œä½†å»ºè®®ä½¿ç”¨å¯†é’¥è®¤è¯ï¼‰

**å­˜å‚¨ï¼š**
- **å·å¤§å°**: 30 GBï¼ˆæ¨èï¼‰
- **å·ç±»å‹**: gp3 (SSD)

3. **å¯åŠ¨å®ä¾‹**
   - ç‚¹å‡» "Launch Instance"
   - ç­‰å¾…å®ä¾‹çŠ¶æ€å˜ä¸º "running"
   - è®°å½•å…¬ç½‘ IP åœ°å€

---

## æ­¥éª¤ 2: é…ç½® EC2 å®ä¾‹

### 2.1 è¿æ¥åˆ°å®ä¾‹

```bash
# Amazon Linux 2023
ssh -i nlp-server1.pem ec2-user@<EC2_IP>

# Ubuntu 22.04
ssh -i nlp-server1.pem ubuntu@<EC2_IP>
```

### 2.2 å®‰è£…åŸºç¡€è½¯ä»¶

**æ–¹å¼ A: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰**

#### æ­¥éª¤ 1: ä¸Šä¼ è„šæœ¬åˆ° EC2

**Windows (Git Bash):**
```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•æ‰§è¡Œ
cd "D:\HKU\First_semester\7607 NLP\NLP_project"

# ä½¿ç”¨ SCP ä¸Šä¼ è„šæœ¬
scp -i ../nlp-server1.pem scripts/setup_ec2.sh ec2-user@<EC2_IP>:~/

# ç¤ºä¾‹ï¼š
# scp -i ../nlp-server1.pem scripts/setup_ec2.sh ec2-user@57.183.36.86:~/
```

**Linux/macOS:**
```bash
# åœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œ
scp -i /path/to/nlp-server1.pem scripts/setup_ec2.sh ec2-user@<EC2_IP>:~/
```

**æˆ–è€…ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºï¼ˆå¦‚æœä¸Šä¼ ä¸æ–¹ä¾¿ï¼‰:**
```bash
# SSH åˆ°æœåŠ¡å™¨åï¼Œç›´æ¥åˆ›å»ºæ–‡ä»¶
nano setup_ec2.sh
# å¤åˆ¶ scripts/setup_ec2.sh çš„å†…å®¹å¹¶ç²˜è´´ï¼Œä¿å­˜é€€å‡ºï¼ˆCtrl+X, Y, Enterï¼‰
```

#### æ­¥éª¤ 2: è¿è¡Œè„šæœ¬

```bash
# SSH åˆ°æœåŠ¡å™¨åæ‰§è¡Œ
chmod +x setup_ec2.sh
./setup_ec2.sh
```

**æ–¹å¼ B: æ‰‹åŠ¨å®‰è£…**

**Amazon Linux 2023:**
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo dnf update -y

# å®‰è£… Pythonã€Git
sudo dnf install -y python3 python3-pip git
python3 -m pip install --upgrade pip

# å®‰è£… Nginxï¼ˆNode.js ä¸éœ€è¦ï¼Œå‰ç«¯æ„å»ºåœ¨ CI/CD ä¸­å®Œæˆï¼‰
sudo dnf install -y nginx
```

**Ubuntu 22.04:**
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Pythonã€Git
sudo apt install -y python3 python3-pip python3-venv git

# å®‰è£… Nginx
sudo apt install -y nginx
```

### 2.3 åˆ›å»ºåº”ç”¨ç›®å½•

```bash
sudo mkdir -p /opt/lightrag-web
sudo chown $USER:$USER /opt/lightrag-web
```

---

## æ­¥éª¤ 3: é…ç½® GitHub Secrets

GitHub Actions éœ€è¦é€šè¿‡ SSH è¿æ¥åˆ° EC2 è¿›è¡Œéƒ¨ç½²ï¼Œå› æ­¤éœ€è¦é…ç½®ä»¥ä¸‹ 3 ä¸ª Secretsï¼š

### 3.1 æ·»åŠ  EC2 å®ä¾‹ IP

1. è¿›å…¥ GitHub ä»“åº“ â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**
2. ç‚¹å‡» **"New repository secret"**
3. æ·»åŠ ï¼š
   - **Name**: `EC2_INSTANCE_IP`
   - **Value**: `57.181.136.172`ï¼ˆæ‚¨çš„ EC2 å…¬ç½‘ IPï¼‰
4. ç‚¹å‡» **"Add secret"**

### 3.2 æ·»åŠ  SSH ç§é’¥

1. **è·å– SSH ç§é’¥å†…å®¹**ï¼ˆåœ¨æœ¬åœ°æ‰§è¡Œï¼‰ï¼š

   **Windows (Git Bash):**
   ```bash
   # åœ¨åŒ…å« nlp-server1.pem çš„ç›®å½•æ‰§è¡Œ
   cat nlp-server1.pem
   ```

   **Windows (PowerShell):**
   ```powershell
   Get-Content nlp-server1.pem
   ```

   **Linux/macOS:**
   ```bash
   cat nlp-server1.pem
   ```

2. **å¤åˆ¶å®Œæ•´çš„å¯†é’¥å†…å®¹**ï¼ˆåŒ…æ‹¬ `-----BEGIN` å’Œ `-----END` è¡Œï¼‰

3. **æ·»åŠ åˆ° GitHub Secrets**ï¼š
   - è¿›å…¥ GitHub ä»“åº“ â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**
   - ç‚¹å‡» **"New repository secret"**
   - **Name**: `EC2_SSH_KEY`
   - **Value**: ç²˜è´´å®Œæ•´çš„ `.pem` æ–‡ä»¶å†…å®¹ï¼ˆåŒ…æ‹¬é¦–å°¾æ ‡è®°ï¼‰
   - ç‚¹å‡» **"Add secret"**

**âš ï¸ é‡è¦æç¤º**ï¼š
- å¯†é’¥å†…å®¹å¿…é¡»å®Œæ•´ï¼ŒåŒ…æ‹¬ `-----BEGIN OPENSSH PRIVATE KEY-----` å’Œ `-----END OPENSSH PRIVATE KEY-----`
- ä¸è¦æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œ
- å¯†é’¥å†…å®¹ä¼šæ˜¾ç¤ºä¸ºéšè—ï¼Œè¿™æ˜¯æ­£å¸¸çš„

### 3.3 æ·»åŠ  LLM API Key

1. è¿›å…¥ GitHub ä»“åº“ â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**
2. ç‚¹å‡» **"New repository secret"**
3. æ·»åŠ ï¼š
   - **Name**: `LLM_BINDING_API_KEY`
   - **Value**: æ‚¨çš„ LLM API Keyï¼ˆä¾‹å¦‚ï¼š`sk-xxx...`ï¼‰
4. ç‚¹å‡» **"Add secret"**

**è¯´æ˜**: æ­¤ API Key ä¼šåœ¨éƒ¨ç½²æ—¶è‡ªåŠ¨å†™å…¥åˆ° EC2 çš„ `.env` æ–‡ä»¶ä¸­ã€‚

### 3.4 éªŒè¯é…ç½®

é…ç½®å®Œæˆåï¼Œæ‚¨åº”è¯¥åœ¨ GitHub Secrets ä¸­çœ‹åˆ°ä»¥ä¸‹ 3 ä¸ªæ¡ç›®ï¼š
- âœ… `EC2_INSTANCE_IP`
- âœ… `EC2_SSH_KEY`
- âœ… `LLM_BINDING_API_KEY`

---

## æ­¥éª¤ 4: é¦–æ¬¡éƒ¨ç½²

### 4.1 è§¦å‘éƒ¨ç½²

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•
git add .
git commit -m "chore: deploy to EC2"
git push origin main
```

### 4.2 ç›‘æ§éƒ¨ç½²

- GitHub â†’ Actions â†’ æŸ¥çœ‹éƒ¨ç½²è¿›åº¦
- ç­‰å¾… "Deploy on EC2" æ­¥éª¤å®Œæˆ

### 4.3 é…ç½®æœåŠ¡å’Œ Nginx

éƒ¨ç½²å®Œæˆåï¼ŒSSH åˆ° EC2 æ‰§è¡Œï¼š

```bash
# é…ç½® systemd æœåŠ¡
sudo cp /tmp/lightrag-deploy/lightrag-backend.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable lightrag-backend
sudo systemctl start lightrag-backend

# é…ç½® Nginxï¼ˆAmazon Linux 2023ï¼‰
sudo mkdir -p /etc/nginx/conf.d
sudo cp /tmp/lightrag-deploy/nginx.conf /etc/nginx/conf.d/lightrag-web.conf

# ç¡®ä¿ä¸»é…ç½®æ–‡ä»¶åŒ…å« conf.d
sudo grep -q "include /etc/nginx/conf.d/\*.conf" /etc/nginx/nginx.conf || \
    echo "include /etc/nginx/conf.d/*.conf;" | sudo tee -a /etc/nginx/nginx.conf

# æµ‹è¯•å¹¶é‡å¯ Nginx
sudo nginx -t
sudo systemctl restart nginx
```

### 4.4 æ‰‹åŠ¨é…ç½® Nginxï¼ˆå¦‚æœéƒ¨ç½²æ–‡ä»¶ä¸å­˜åœ¨ï¼‰

å¦‚æœ `/tmp/lightrag-deploy/nginx.conf` ä¸å­˜åœ¨ï¼ˆå¸¸è§é—®é¢˜ï¼‰ï¼Œæ‰‹åŠ¨åˆ›å»ºï¼š

```bash
# åˆ›å»ºé…ç½®ç›®å½•
sudo mkdir -p /etc/nginx/conf.d

# åˆ›å»º Nginx é…ç½®
sudo tee /etc/nginx/conf.d/lightrag-web.conf > /dev/null << 'EOF'
server {
    listen 80;
    server_name _;
    
    location / {
        root /opt/lightrag-web/frontend/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        client_max_body_size 50M;
    }
}
EOF

# ç¡®ä¿ä¸»é…ç½®æ–‡ä»¶åŒ…å« conf.d
sudo grep -q "include /etc/nginx/conf.d/\*.conf" /etc/nginx/nginx.conf || \
    echo "include /etc/nginx/conf.d/*.conf;" | sudo tee -a /etc/nginx/nginx.conf

# æµ‹è¯•å¹¶é‡å¯
sudo nginx -t
sudo systemctl restart nginx
```

---

## æ­¥éª¤ 5: éªŒè¯éƒ¨ç½²

### 5.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
sudo systemctl status lightrag-backend

# æ£€æŸ¥ Nginx
sudo systemctl status nginx

# æŸ¥çœ‹åç«¯æ—¥å¿—
sudo journalctl -u lightrag-backend -n 50
```

### 5.2 æµ‹è¯•è®¿é—®

åœ¨æµè§ˆå™¨è®¿é—®ï¼š`http://<EC2_IP>`

### 5.3 æµ‹è¯• API

```bash
curl http://<EC2_IP>/api/conversations
```

---

## æ­¥éª¤ 6: å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: éƒ¨ç½²æ–‡ä»¶ä¸å­˜åœ¨ âš ï¸

**ç—‡çŠ¶**: `cp: cannot stat '/tmp/lightrag-deploy/nginx.conf': No such file or directory`

**åŸå› **: GitHub Actions å°šæœªè¿è¡Œæˆ–æ–‡ä»¶æœªä¸Šä¼ æˆåŠŸ

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ GitHub Actions æ˜¯å¦å·²å®Œæˆï¼ˆGitHub â†’ Actionsï¼‰
2. æˆ–ä½¿ç”¨ **4.4 æ‰‹åŠ¨é…ç½® Nginx** æ­¥éª¤åˆ›å»ºé…ç½®æ–‡ä»¶

### é—®é¢˜ 2: æœåŠ¡æ— æ³•å¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo journalctl -u lightrag-backend -n 100

# æ£€æŸ¥ .env æ–‡ä»¶
cat /opt/lightrag-web/backend/.env

# æ£€æŸ¥ Python ç¯å¢ƒ
cd /opt/lightrag-web/backend
source venv/bin/activate
python3 -c "import app.main; print('OK')"
```

### é—®é¢˜ 3: å‰ç«¯æ— æ³•è®¿é—®

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ Nginx çŠ¶æ€ï¼š`sudo systemctl status nginx`
2. æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š`sudo nginx -t`
3. æ£€æŸ¥å‰ç«¯æ–‡ä»¶ï¼š`ls -la /opt/lightrag-web/frontend/dist/`

### é—®é¢˜ 4: API è°ƒç”¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥åç«¯æœåŠ¡ï¼š`sudo systemctl status lightrag-backend`
2. æ£€æŸ¥ç«¯å£ï¼š`sudo netstat -tlnp | grep 8000`
3. æ£€æŸ¥ CORS é…ç½®ï¼ˆ`backend/app/config.py`ï¼‰

---

## å¿«é€Ÿå‚è€ƒ

### å…³é”®å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status lightrag-backend
sudo systemctl status nginx

# é‡å¯æœåŠ¡
sudo systemctl restart lightrag-backend
sudo systemctl restart nginx

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u lightrag-backend -f

# æµ‹è¯• Nginx é…ç½®
sudo nginx -t

# æ£€æŸ¥ç«¯å£
sudo netstat -tlnp | grep -E '80|8000'
```

### å…³é”®è·¯å¾„

- åº”ç”¨ç›®å½•: `/opt/lightrag-web`
- åç«¯é…ç½®: `/opt/lightrag-web/backend/.env`
- Nginx é…ç½®: `/etc/nginx/conf.d/lightrag-web.conf`
- æœåŠ¡é…ç½®: `/etc/systemd/system/lightrag-backend.service`

---

## æ€»ç»“

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼š

1. âœ… åº”ç”¨è¿è¡Œåœ¨ `/opt/lightrag-web`
2. âœ… åç«¯æœåŠ¡é€šè¿‡ systemd ç®¡ç†
3. âœ… Nginx æä¾›å‰ç«¯å’Œ API ä»£ç†
4. âœ… å¯é€šè¿‡ `http://<EC2_IP>` è®¿é—®
5. âœ… LLM API Key è‡ªåŠ¨ä» GitHub Secrets é…ç½®

å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—æˆ–æ£€æŸ¥æœåŠ¡çŠ¶æ€ã€‚

