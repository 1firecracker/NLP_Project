# 出题模块使用指南

## 🎯 修复概述
已修复出题模块缓存问题，现在每次生成都会基于新上传的PDF生成全新题目。

## ✅ 核心改进

### 1. 自动清缓存
- 每次点击"生成试题"时，自动清除旧的题库文件
- 确保生成的题目是全新的，不会重复

### 2. 严格会话隔离
- 每个会话独立，不再混用其他会话的数据
- 上传什么PDF就基于什么PDF生成

### 3. 友好错误提示
- 明确提示未上传样本、解析中、解析失败等不同情况
- 帮助用户快速定位问题

## 📋 正确使用流程

### 步骤1：上传样本试卷
1. 进入【样本试卷】模块
2. 点击"上传文件"
3. 选择 PDF、DOCX 或 TXT 文件
4. 等待上传完成

### 步骤2：等待解析完成
- 查看样本状态，确保显示为"✅ 已完成"
- 如果显示"⏳ 解析中"，请稍等片刻
- 如果显示"❌ 失败"，请重新上传

### 步骤3：生成试题
1. 确认有"已完成"状态的样本
2. 点击"生成试题"按钮
3. 等待生成完成（会看到"正在清除旧缓存并生成全新题目..."）
4. 生成成功后会显示题目列表

### 步骤4：查看和使用
- 查看生成的题目
- 导出题目
- 让学生答题
- 批改评分

## ⚠️ 常见问题

### Q1：为什么提示"未找到任何样本试卷"？
**A**: 需要先在当前会话上传样本。每个会话独立，不共享其他会话的样本。

**解决方法：**
1. 检查是否在当前会话上传了样本
2. 如果有样本但仍提示，刷新页面重试

### Q2：为什么提示"样本正在解析中"？
**A**: 文件上传后需要一定时间解析（PDF转文本、提取题目等）。

**解决方法：**
1. 等待10-30秒（视文件大小）
2. 刷新页面查看状态
3. 状态变为"已完成"后再生成

### Q3：生成的题目还是重复怎么办？
**A**: 如果修复后仍重复，可能是浏览器缓存。

**解决方法：**
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 刷新页面（Ctrl+F5）
3. 重新上传样本并生成

### Q4：如何完全清除所有历史数据？
**A**: 可以手动删除数据目录。

**PowerShell命令：**
```powershell
# 列出所有缓存
Get-ChildItem -Directory .\backend\data | Where-Object { $_.Name -match "_generated$|_corrected$|_graded$" }

# 删除所有缓存（谨慎操作！）
Get-ChildItem -Directory .\backend\data | Where-Object { $_.Name -match "_generated$|_corrected$|_graded$" } | ForEach-Object { Remove-Item -Recurse -Force $_.FullName }
```

## 🔧 技术细节

### 缓存清除机制
每次生成前会自动删除：
- `backend/data/<会话ID>_generated/` - 生成的题库
- `backend/data/<会话ID>_corrected/` - 校对后的题库
- `backend/data/<会话ID>_graded/` - 批改后的题库

### 内存状态重置
清除 `shared_state` 中的：
- `question_bank` - 题库对象
- `generated_questions` - 生成题目
- `quality_report` - 质量报告
- 等等...

### ID映射机制
学生提交答案时，自动映射：
- `Q001: A` → `GEN_001`
- `Q002: B` → `GEN_002`
- `1. A` → `GEN_001`
- `2. B` → `GEN_002`

## 🚀 启动服务器

### 后端（端口 8000）
```powershell
cd backend
.\venv\Scripts\python.exe -m uvicorn app.main:app --reload --host 127.0.0.1 --port 8000
```

### 前端（端口 5173）
```powershell
cd frontend
npm run dev
```

### 一键启动（推荐）
```powershell
.\start_all.ps1
```

## 📊 验证修复

### 测试步骤
1. 上传第一个PDF（例如：数学试卷）
2. 生成题目，记录题目内容
3. 上传第二个PDF（例如：英语试卷）
4. 再次生成题目
5. **预期结果**：第二次生成的题目完全不同，基于第二个PDF

### 成功标志
- ✅ 生成状态显示"正在清除旧缓存..."
- ✅ 题目内容与新上传的PDF相关
- ✅ 题目ID从 GEN_001 开始重新编号
- ✅ 不会出现旧PDF的内容

## 💡 最佳实践

1. **一次一个样本**：建议每个会话只上传一个样本，生成后再换会话
2. **命名规范**：会话ID用有意义的名称（如：math_exam_2025）
3. **定期清理**：定期删除不需要的生成缓存，节省磁盘空间
4. **检查状态**：生成前确认样本状态为"已完成"

## 📝 更新日志

**2025-11-20 修复内容：**
- ✅ 添加自动缓存清除功能
- ✅ 移除自动兜底机制（不再使用其他会话数据）
- ✅ 改进错误提示（区分不同错误类型）
- ✅ 修复答案ID映射问题
- ✅ 优化评分fallback逻辑
- ✅ 前端用户体验改进

---
**问题反馈**：如遇问题请查看 `CHANGELOG_出题模块修复.md` 获取详细技术信息
